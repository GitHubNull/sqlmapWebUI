# 核心功能详解

<cite>
**本文档引用的文件**   
- [app.py](file://src/backEnd/app.py)
- [main.py](file://src/backEnd/main.py)
- [config.py](file://src/backEnd/config.py)
- [webTaskController.py](file://src/backEnd/api/commonApi/webTaskController.py)
- [taskService.py](file://src/backEnd/service/taskService.py)
- [Task.py](file://src/backEnd/model/Task.py)
- [headerController.py](file://src/backEnd/api/commonApi/headerController.py)
- [headerRuleService.py](file://src/backEnd/service/headerRuleService.py)
- [TaskList/index.vue](file://src/frontEnd/src/views/TaskList/index.vue)
- [AddTask/index.vue](file://src/frontEnd/src/views/AddTask/index.vue)
- [TaskDetail/index.vue](file://src/frontEnd/src/views/TaskDetail/index.vue)
- [task.ts](file://src/frontEnd/src/stores/task.ts)
</cite>

## 目录
1. [任务管理](#任务管理)
2. [扫描配置](#扫描配置)
3. [HTTP请求解析](#http请求解析)
4. [请求头规则](#请求头规则)

## 任务管理

sqlmapWebUI的任务管理模块是整个系统的核心，负责扫描任务的创建、执行、监控和销毁。该模块采用前后端分离架构，前端通过Vue 3和Pinia实现用户界面和状态管理，后端基于FastAPI提供RESTful API接口。

任务管理的业务逻辑主要由`taskService.py`中的`TaskService`类实现。当用户通过前端界面提交扫描任务时，请求首先由`webTaskController.py`中的`add_task_from_web`接口接收。该接口对请求参数进行验证后，调用`taskService`的`star_task`方法创建任务。`star_task`方法会生成一个唯一的任务ID，并将任务信息存储在`DataStore.tasks`字典中。

任务的执行流程在`Task.py`的`engine_start`方法中定义。该方法首先应用请求头规则，然后将HTTP请求信息写入临时文件，最后启动SQLMap引擎进行扫描。任务状态通过`TaskStatus`枚举类管理，包括New（新建）、Runnable（可运行）、Running（运行中）、Blocked（已阻塞）和Terminated（已终止）等状态。

前端通过`task.ts`中的Pinia store管理任务状态。`useTaskStore`提供了`fetchTaskList`、`deleteTask`、`stopTask`等方法，与后端API进行交互。任务列表页面（`TaskList/index.vue`）使用PrimeVue的DataTable组件展示任务信息，支持分页、排序和过滤功能。用户可以查看任务的扫描URL、主机、状态、创建时间等详细信息，并执行停止、删除等操作。

任务详情页面（`TaskDetail/index.vue`）以标签页形式展示任务的详细信息，包括基础信息、HTTP请求信息、扫描配置、扫描结果、任务日志和错误记录。该页面使用组合式函数`useTaskDetail`管理复杂的业务逻辑，实现了数据的懒加载和按需加载。

**Section sources**
- [taskService.py](file://src/backEnd/service/taskService.py#L1-L535)
- [Task.py](file://src/backEnd/model/Task.py#L1-L333)
- [webTaskController.py](file://src/backEnd/api/commonApi/webTaskController.py#L1-L91)
- [task.ts](file://src/frontEnd/src/stores/task.ts#L1-L390)
- [TaskList/index.vue](file://src/frontEnd/src/views/TaskList/index.vue#L1-L1119)
- [TaskDetail/index.vue](file://src/frontEnd/src/views/TaskDetail/index.vue#L1-L301)

## 扫描配置

扫描配置模块允许用户自定义SQLMap的扫描参数，以适应不同的测试场景。该模块通过`AddTask/index.vue`组件实现，提供了一个直观的表单界面，用户可以在其中设置各种扫描选项。

扫描配置分为多个功能区域，包括检测选项、注入选项、技术选项、请求选项、枚举选项和通用选项。检测选项允许用户设置检测等级（Level）和风险等级（Risk），以及是否启用智能检测和仅文本比较。注入选项用于指定目标数据库（DBMS）、操作系统（OS）、测试参数、跳过参数、注入前缀和后缀等。

技术选项允许用户选择要使用的注入技术，包括布尔盲注（B）、报错注入（E）、联合查询（U）、堆叠查询（S）、时间盲注（T）和内联查询（Q）。用户还可以设置时间盲注的延迟时间。请求选项包括线程数、超时时间、重试次数、请求延迟等，用户还可以选择是否使用随机User-Agent或Tor代理。

枚举选项提供了获取数据库信息的功能，包括获取Banner、当前用户、当前数据库、是否为DBA、获取所有数据库、获取所有表、获取所有列和导出表数据等。通用选项包括批处理模式、解析表单、刷新会话和刷新查询等。

用户可以通过配置预设功能保存和加载常用的扫描配置。预设配置存储在`scanPresetDatabase.py`中，用户可以在添加任务时选择预设配置，快速应用一组扫描参数。配置预设功能通过`scanPresetStore`管理，支持创建、编辑和删除预设。

**Section sources**
- [AddTask/index.vue](file://src/frontEnd/src/views/AddTask/index.vue#L1-L1092)
- [scanPresetService.py](file://src/backEnd/service/scanPresetService.py)
- [ScanPresetDatabase.py](file://src/backEnd/model/ScanPresetDatabase.py)

## HTTP请求解析

HTTP请求解析模块负责将用户从浏览器开发者工具复制的HTTP请求转换为SQLMap可识别的格式。该模块通过`AddTask/index.vue`组件中的`HttpCodeEditor`实现，支持多种输入格式，包括cURL、PowerShell、fetch和原始HTTP报文。

当用户粘贴HTTP请求报文时，系统会自动检测其格式并显示相应的格式指示器。用户点击"解析转换"按钮后，系统调用`httpRequestParser`模块的`parseHttpRequest`函数进行解析。该函数根据输入格式调用相应的解析器，如`curlParser`、`powershellParser`或`rawHttpParser`，将输入转换为统一的HTTP请求对象。

解析后的HTTP请求以原始报文格式显示在编辑器中，用户可以直接编辑报文内容。用户可以在参数值中添加`*`标记来指定注入点。系统还提供了请求信息预览功能，显示请求方法、主机和路径等基本信息。

解析后的HTTP请求信息包括URL、主机、请求头和请求体。这些信息将作为扫描任务的输入参数，提交给SQLMap引擎进行扫描。请求头和请求体的处理在`Task.py`的`_build_raw_http_request`方法中实现，该方法根据输入信息构建完整的HTTP原始报文。

**Section sources**
- [AddTask/index.vue](file://src/frontEnd/src/views/AddTask/index.vue#L1-L1092)
- [httpRequestParser](file://src/frontEnd/src/utils/httpRequestParser)
- [Task.py](file://src/backEnd/model/Task.py#L1-L333)

## 请求头规则

请求头规则模块允许用户定义和管理持久化和会话性的请求头规则。该模块通过`headerController.py`和`headerRuleService.py`实现，提供了完整的CRUD操作接口。

持久化请求头规则存储在数据库中，具有名称、请求头名称、请求头值、替换策略、匹配条件、优先级和作用域等属性。用户可以通过`headerController.py`中的`create_persistent_header_rule`接口创建规则，通过`get_persistent_header_rules`接口获取规则列表。规则的优先级决定了其应用顺序，优先级高的规则先应用。

会话性请求头规则与客户端IP地址关联，用于临时覆盖持久化规则。用户可以通过`set_session_headers`接口设置会话性请求头，通过`get_session_headers`接口获取当前会话的请求头。会话性请求头在用户会话期间有效，重启服务后失效。

请求头规则的应用在`Task.py`的`apply_header_rules`方法中实现。该方法在SQLMap引擎启动前调用，动态导入`headerRuleService`和`HeaderProcessor`，获取活跃的持久化规则和会话性请求头，然后调用`HeaderProcessor.process_headers`方法处理请求头。处理后的请求头通过`options.headers`参数传递给SQLMap引擎。

前端通过配置管理页面提供请求头规则的管理界面，用户可以创建、编辑、删除和批量操作请求头规则。系统还提供了请求头处理预览功能，用户可以在应用规则前预览处理结果。

**Section sources**
- [headerController.py](file://src/backEnd/api/commonApi/headerController.py#L1-L481)
- [headerRuleService.py](file://src/backEnd/service/headerRuleService.py#L1-L976)
- [Task.py](file://src/backEnd/model/Task.py#L1-L333)
- [HeaderProcessor.py](file://src/backEnd/utils/header_processor.py)