# 任务过滤器增强

<cite>
**本文档引用的文件**   
- [TaskFilter.vue](file://src/frontEnd/src/components/TaskFilter.vue)
- [task.ts](file://src/frontEnd/src/stores/task.ts)
- [TaskList/index.vue](file://src/frontEnd/src/views/TaskList/index.vue)
- [task.ts](file://src/frontEnd/src/types/task.ts)
- [Task.py](file://src/backEnd/model/Task.py)
- [headerController.py](file://src/backEnd/api/commonApi/headerController.py)
- [headerRuleService.py](file://src/backEnd/service/headerRuleService.py)
- [header_processor.py](file://src/backEnd/utils/header_processor.py)
- [scope_matcher.py](file://src/backEnd/utils/scope_matcher.py)
- [TaskStatus.py](file://src/backEnd/model/TaskStatus.py)
</cite>

## 目录
1. [简介](#简介)
2. [项目结构](#项目结构)
3. [核心组件](#核心组件)
4. [架构概述](#架构概述)
5. [详细组件分析](#详细组件分析)
6. [依赖分析](#依赖分析)
7. [性能考虑](#性能考虑)
8. [故障排除指南](#故障排除指南)
9. [结论](#结论)

## 简介
本项目是一个现代化的 SQLMap Web 界面，为安全研究人员提供便捷的 SQL 注入测试平台。核心功能包括任务管理、实时日志查看、扫描结果展示、HTTP 请求查看、批量操作以及扩展集成。本文档重点分析任务过滤器的增强功能，该功能允许用户根据多种条件对任务进行筛选和排序，提高任务管理的效率。

## 项目结构
项目采用前后端分离的架构，前端使用 Vue 3 和 TypeScript 构建，后端使用 FastAPI 和 Python 3.10+。项目结构清晰，分为前端和后端两个主要部分，每个部分都有明确的目录划分。

```mermaid
graph TB
A[sqlmapWebUI] --> B[src]
A --> C[doc]
A --> D[.gitignore]
A --> E[README.md]
B --> F[backEnd]
B --> G[frontEnd]
F --> H[api]
F --> I[model]
F --> J[service]
F --> K[utils]
F --> L[third_lib]
F --> M[app.py]
F --> N[main.py]
G --> O[src]
G --> P[.env.development]
G --> Q[.env.production]
G --> R[package.json]
O --> S[api]
O --> T[components]
O --> U[stores]
O --> V[types]
O --> W[utils]
O --> X[views]
O --> Y[App.vue]
O --> Z[main.ts]
```

**Diagram sources**
- [src/frontEnd/src/components/TaskFilter.vue](file://src/frontEnd/src/components/TaskFilter.vue)
- [src/backEnd/model/Task.py](file://src/backEnd/model/Task.py)

**Section sources**
- [src/frontEnd/src/components/TaskFilter.vue](file://src/frontEnd/src/components/TaskFilter.vue)
- [src/backEnd/model/Task.py](file://src/backEnd/model/Task.py)

## 核心组件
任务过滤器是前端任务管理界面的核心组件之一，它允许用户根据多种条件对任务进行筛选和排序。任务过滤器组件与任务状态管理 store 紧密协作，实现高效的任务管理。

**Section sources**
- [src/frontEnd/src/components/TaskFilter.vue](file://src/frontEnd/src/components/TaskFilter.vue)
- [src/frontEnd/src/stores/task.ts](file://src/frontEnd/src/stores/task.ts)

## 架构概述
系统架构采用前后端分离模式，前端通过 API 与后端进行通信。后端提供 RESTful API 接口，处理任务的创建、查询、更新和删除等操作。前端通过 Pinia 状态管理 store 管理任务状态，并通过组件化的方式实现用户界面。

```mermaid
graph LR
A[前端] --> |HTTP请求| B[后端API]
B --> C[任务管理]
B --> D[请求头规则]
B --> E[会话管理]
C --> F[任务模型]
D --> G[持久化规则]
E --> H[会话头]
F --> I[数据库]
G --> I
H --> I
```

**Diagram sources**
- [src/frontEnd/src/stores/task.ts](file://src/frontEnd/src/stores/task.ts)
- [src/backEnd/service/headerRuleService.py](file://src/backEnd/service/headerRuleService.py)

## 详细组件分析
### 任务过滤器组件分析
任务过滤器组件提供了多种筛选条件，包括URL关键字、报文关键字、任务状态、创建时间、执行时间等。用户可以通过这些条件快速找到所需的任务。

#### 任务过滤器类图
```mermaid
classDiagram
class TaskFilter {
+filters : TaskFilters
+filteredCount : number
+totalCount : number
+localFilters : TaskFilters
+createDateRange : Date[] | null
+execDateRange : Date[] | null
+statusOptions : Array
+injectableOptions : Array
+hasActiveFilters : boolean
+onFilterChange()
+confirmCreateDate()
+confirmExecDate()
+resetFilters()
}
class TaskFilters {
+urlKeyword? : string
+messageKeyword? : string
+status? : TaskStatus
+startDate? : string
+endDate? : string
+execStartDate? : string
+execEndDate? : string
+injectableStatus? : 'injectable' | 'not_injectable' | 'unknown'
}
TaskFilter --> TaskFilters : "使用"
```

**Diagram sources**
- [src/frontEnd/src/components/TaskFilter.vue](file://src/frontEnd/src/components/TaskFilter.vue)
- [src/frontEnd/src/types/task.ts](file://src/frontEnd/src/types/task.ts)

#### 任务过滤器序列图
```mermaid
sequenceDiagram
participant 用户
participant TaskFilter as 任务过滤器
participant TaskStore as 任务状态管理
participant 后端API
用户->>TaskFilter : 输入筛选条件
TaskFilter->>TaskFilter : 防抖处理
TaskFilter->>TaskStore : 更新筛选条件
TaskStore->>TaskStore : 计算过滤后的任务列表
TaskStore->>TaskStore : 计算排序后的任务列表
TaskStore->>用户 : 更新任务列表显示
```

**Diagram sources**
- [src/frontEnd/src/components/TaskFilter.vue](file://src/frontEnd/src/components/TaskFilter.vue)
- [src/frontEnd/src/stores/task.ts](file://src/frontEnd/src/stores/task.ts)

### 任务状态管理分析
任务状态管理 store 负责管理所有任务的状态，包括任务列表、当前任务、筛选条件、排序配置等。它还提供了计算属性来统计任务的各种状态。

#### 任务状态管理类图
```mermaid
classDiagram
class TaskStore {
+taskList : Task[]
+currentTask : Task | null
+currentTaskDetail : TaskDetail | null
+loading : boolean
+filters : TaskFilters
+sortConfig : SortConfig
+selectedTaskIds : string[]
+taskStats : TaskStats
+filteredTaskList : Task[]
+sortedTaskList : Task[]
+fetchTaskList()
+createTask()
+deleteTask()
+stopTask()
+updateTaskStatus()
+setCurrentTask()
+setFilters()
+clearFilters()
+setSortConfig()
+setSelectedTaskIds()
+toggleTaskSelection()
+clearSelection()
+batchDeleteTasks()
+batchStopTasks()
+deleteAllTasks()
}
class Task {
+engineid : number
+taskid : string
+scanUrl : string
+host : string
+status : TaskStatus
+createTime : string
+startTime? : string
+headers? : string[]
+body? : string
+options? : TaskOptions
+updateTime? : string
+remote_addr? : string
+injected? : boolean
+errors? : number
+logs? : number
}
class TaskFilters {
+urlKeyword? : string
+messageKeyword? : string
+status? : TaskStatus
+startDate? : string
+endDate? : string
+execStartDate? : string
+execEndDate? : string
+injectableStatus? : 'injectable' | 'not_injectable' | 'unknown'
}
class SortConfig {
+field : string
+order : 'asc' | 'desc' | null
}
class TaskStats {
+total : number
+running : number
+pending : number
+success : number
+failed : number
+stopped : number
+terminated : number
+injectable : number
+nonInjectable : number
+unknown : number
}
TaskStore --> Task : "包含"
TaskStore --> TaskFilters : "使用"
TaskStore --> SortConfig : "使用"
TaskStore --> TaskStats : "计算"
```

**Diagram sources**
- [src/frontEnd/src/stores/task.ts](file://src/frontEnd/src/stores/task.ts)
- [src/frontEnd/src/types/task.ts](file://src/frontEnd/src/types/task.ts)

#### 任务状态管理序列图
```mermaid
sequenceDiagram
participant 用户
participant TaskList as 任务列表页面
participant TaskStore as 任务状态管理
participant 后端API
用户->>TaskList : 进入任务列表页面
TaskList->>TaskStore : 调用fetchTaskList()
TaskStore->>后端API : 发送GET请求获取任务列表
后端API-->>TaskStore : 返回任务列表数据
TaskStore->>TaskStore : 更新taskList状态
TaskStore->>TaskStore : 计算taskStats、filteredTaskList、sortedTaskList
TaskStore-->>TaskList : 返回任务列表数据
TaskList->>用户 : 显示任务列表
```

**Diagram sources**
- [src/frontEnd/src/stores/task.ts](file://src/frontEnd/src/stores/task.ts)
- [src/frontEnd/src/views/TaskList/index.vue](file://src/frontEnd/src/views/TaskList/index.vue)

### 后端任务处理分析
后端负责处理任务的创建、查询、更新和删除等操作。任务模型定义了任务的基本属性，任务服务提供了业务逻辑处理。

#### 任务模型类图
```mermaid
classDiagram
class Task {
-status : TaskStatus
-create_datetime : datetime
-start_datetime : datetime
-taskid : string
-scanUrl : string
-host : string
-headers : list
-body : string
-remote_addr : string
-process : Popen
-output_directory : string
-options : AttribDict
-_original_options : AttribDict
-_header_rules_applied : boolean
+__init__(taskid, remote_addr, scanUrl, host, headers, body)
+initialize_options(taskid)
+set_option(option, value)
+get_option(option)
+get_options()
+reset_options()
+apply_header_rules()
+engine_start()
+engine_stop()
+engine_process()
+engine_kill()
+engine_get_id()
+engine_get_returncode()
+engine_has_terminated()
}
class TaskStatus {
+New : int
+Runnable : int
+Running : int
+Terminated : int
}
Task --> TaskStatus : "使用"
```

**Diagram sources**
- [src/backEnd/model/Task.py](file://src/backEnd/model/Task.py)
- [src/backEnd/model/TaskStatus.py](file://src/backEnd/model/TaskStatus.py)

#### 任务处理序列图
```mermaid
sequenceDiagram
participant 前端
participant 后端API
participant TaskService as 任务服务
participant Task as 任务模型
participant SQLMap as SQLMap引擎
前端->>后端API : 发送创建任务请求
后端API->>TaskService : 调用star_task方法
TaskService->>Task : 创建任务实例
Task->>Task : 初始化选项
Task->>Task : 应用请求头规则
Task->>SQLMap : 启动SQLMap引擎
SQLMap-->>Task : 返回进程ID
Task-->>TaskService : 返回任务ID和引擎ID
TaskService-->>后端API : 返回响应
后端API-->>前端 : 返回任务创建成功
```

**Diagram sources**
- [src/backEnd/service/taskService.py](file://src/backEnd/service/taskService.py)
- [src/backEnd/model/Task.py](file://src/backEnd/model/Task.py)

## 依赖分析
系统各组件之间存在紧密的依赖关系。前端组件依赖于 Pinia 状态管理 store，store 又依赖于后端 API。后端 API 依赖于服务层，服务层依赖于数据模型和工具类。

```mermaid
graph TD
A[TaskFilter.vue] --> B[task.ts]
C[TaskList/index.vue] --> B
D[TaskDetail/index.vue] --> B
B --> E[task.ts API]
E --> F[后端API]
F --> G[taskService.py]
G --> H[Task.py]
G --> I[TaskStatus.py]
F --> J[headerRuleService.py]
J --> K[header_processor.py]
J --> L[scope_matcher.py]
K --> L
```

**Diagram sources**
- [src/frontEnd/src/components/TaskFilter.vue](file://src/frontEnd/src/components/TaskFilter.vue)
- [src/frontEnd/src/stores/task.ts](file://src/frontEnd/src/stores/task.ts)
- [src/backEnd/service/taskService.py](file://src/backEnd/service/taskService.py)
- [src/backEnd/service/headerRuleService.py](file://src/backEnd/service/headerRuleService.py)

## 性能考虑
任务过滤器的设计考虑了性能优化。前端通过计算属性实现了响应式的任务列表过滤和排序，避免了重复计算。后端通过数据库查询优化和缓存机制提高了任务查询的效率。

## 故障排除指南
### 任务过滤器不生效
1. 检查筛选条件是否正确输入
2. 检查任务状态管理 store 的筛选条件是否正确更新
3. 检查后端 API 是否返回正确的任务列表

### 任务列表加载缓慢
1. 检查网络连接是否正常
2. 检查后端数据库查询是否优化
3. 检查任务数量是否过多，考虑分页加载

**Section sources**
- [src/frontEnd/src/components/TaskFilter.vue](file://src/frontEnd/src/components/TaskFilter.vue)
- [src/frontEnd/src/stores/task.ts](file://src/frontEnd/src/stores/task.ts)

## 结论
任务过滤器增强功能显著提高了任务管理的效率。通过多种筛选条件和排序选项，用户可以快速找到所需的任务。系统架构设计合理，前后端分离，组件化开发，便于维护和扩展。未来可以考虑增加更多筛选条件，如按扫描结果、按错误数量等，进一步提升用户体验。