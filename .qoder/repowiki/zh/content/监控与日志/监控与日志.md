# 监控与日志

<cite>
**本文档引用的文件**  
- [LogRecorder.py](file://src/backEnd/model/LogRecorder.py)
- [task_monitor.py](file://src/backEnd/utils/task_monitor.py)
- [config.py](file://src/backEnd/config.py)
- [Database.py](file://src/backEnd/model/Database.py)
- [app.py](file://src/backEnd/app.py) - *新增健康检查端点*
- [useSmartPolling.ts](file://src/frontEnd/src/utils/useSmartPolling.ts) - *新增智能轮询机制*
- [OfflineBanner.vue](file://src/frontEnd/src/components/OfflineBanner.vue) - *新增离线状态提示组件*
- [auth.ts](file://src/frontEnd/src/stores/auth.ts) - *新增后端健康状态管理*
</cite>

## 更新摘要
**已更新内容**
- 在“简介”部分增加了后端健康检查机制的说明
- 新增“后端健康检查机制”章节，详细说明健康检查端点、状态管理、智能轮询和离线提示功能
- 更新“异常告警机制”部分，补充前端健康检查相关的告警策略
- 更新“系统健康检查清单”，增加对健康检查端点的验证项

**新增内容**
- 详细描述了 `/api/health` 健康检查API的响应结构和用途
- 说明了前端 `useSmartPolling` 智能轮询Hook的工作机制
- 解释了 `OfflineBanner` 组件在不同网络和服务状态下的显示逻辑
- 描述了 `authStore` 中 `backendHealthy` 状态的管理方式

**已移除内容**
- 无

**来源跟踪系统更新**
- 更新了文档级引用文件列表，添加了4个新文件
- 为新章节添加了详细的节级来源引用
- 保持原有章节的来源引用不变

## 目录
1. [简介](#简介)
2. [后端健康检查机制](#后端健康检查机制)
3. [任务监控器工作原理](#任务监控器工作原理)
4. [日志记录策略](#日志记录策略)
5. [系统关键指标收集](#系统关键指标收集)
6. [日志轮转与存储](#日志轮转与存储)
7. [Prometheus与Grafana集成](#prometheus与grafana集成)
8. [异常告警机制](#异常告警机制)
9. [性能瓶颈分析指南](#性能瓶颈分析指南)
10. [系统健康检查清单](#系统健康检查清单)

## 简介
本文档详细说明了SQLMap WebUI系统的监控与日志机制。系统通过任务监控器实现对扫描任务的动态调度与状态管理，同时采用数据库持久化方式记录运行日志。文档涵盖了监控频率、状态检查逻辑、自动恢复机制、日志级别管理、关键指标收集、日志轮转策略以及告警通知机制等核心运维内容。

**新增** 系统现已实现完整的后端健康检查机制，通过 `/api/health` 端点提供服务健康状态信息，并在前端实现了智能轮询和离线状态提示功能，显著增强了系统的可观测性和用户体验。

## 后端健康检查机制

系统实现了完整的后端健康检查机制，用于监控服务可用性并为前端提供状态反馈。

### 健康检查端点
后端提供了 `/api/health` API端点，用于返回服务的健康状态信息。

```mermaid
flowchart TD
A[前端请求] --> B[/api/health]
B --> C{服务状态检查}
C --> D[计算运行时长]
D --> E[收集版本信息]
E --> F[构建响应数据]
F --> G[返回JSON响应]
```

响应数据包含以下关键信息：
- **status**: 服务状态（"healthy"表示健康）
- **timestamp**: 当前时间戳（毫秒）
- **version**: 系统版本号
- **uptime**: 服务运行时长（秒）

**Section sources**
- [app.py](file://src/backEnd/app.py#L46-L64) - *健康检查端点实现*

### 健康状态管理
前端通过 `authStore` 状态管理器维护后端健康状态：

```mermaid
classDiagram
class authStore {
+backendHealthy : boolean
+lastHealthCheck : number
+healthCheckInterval : 30000
+checkBackendHealth() : Promise<boolean>
+resetHealthCheck() : void
}
```

`backendHealthy` 状态遵循以下规则：
- 初始状态为 `true`
- 每30秒自动检查一次
- 检查失败时设置为 `false`
- 支持手动重置以强制重新检查

**Section sources**
- [auth.ts](file://src/frontEnd/src/stores/auth.ts#L20-L25) - *健康状态定义*
- [auth.ts](file://src/frontEnd/src/stores/auth.ts#L120-L170) - *健康检查方法实现*

### 智能轮询机制
前端 `useSmartPolling` Hook实现了智能轮询功能，根据多种条件动态调整轮询行为。

```mermaid
flowchart TD
A[轮询决策] --> B{网络状态}
B --> |离线| C[暂停轮询]
B --> |在线| D{后端健康}
D --> |不健康| E[暂停轮询]
D --> |健康| F{页面可见性}
F --> |隐藏| G[使用backgroundInterval]
F --> |可见| H[使用interval]
```

轮询决策逻辑：
1. **网络状态检查**：离线时暂停所有轮询
2. **后端健康检查**：根据 `pauseOnUnhealthy` 配置决定是否在后端不健康时暂停
3. **页面可见性检查**：页面隐藏时使用较长的轮询间隔

**Section sources**
- [useSmartPolling.ts](file://src/frontEnd/src/utils/useSmartPolling.ts#L20-L201) - *智能轮询完整实现*

### 离线状态提示
当检测到网络离线或后端服务不可用时，系统会显示 `OfflineBanner` 提示组件。

```mermaid
stateDiagram-v2
[*] --> Normal
Normal --> Offline : 网络断开
Normal --> BackendUnhealthy : 健康检查失败
Offline --> Normal : 网络恢复
BackendUnhealthy --> Normal : 健康检查通过
Offline --> BackendUnhealthy : 网络恢复但服务未启动
BackendUnhealthy --> Offline : 服务启动但网络断开
class OfflineBanner {
+showBanner : computed
+message : computed
+handleNetworkChange()
}
```

提示消息根据状态显示不同内容：
- **网络离线**："您当前处于离线状态，部分功能不可用"
- **后端不健康**："无法连接到后端服务，请检查服务是否已启动"

**Section sources**
- [OfflineBanner.vue](file://src/frontEnd/src/components/OfflineBanner.vue) - *离线提示组件实现*

## 任务监控器工作原理

任务监控器负责管理所有扫描任务的生命周期，包括任务调度、状态检查和资源分配。监控器通过定期检查任务状态来决定是否启动新的可运行任务。

```mermaid
flowchart TD
Start([开始监控]) --> CheckTasks["检查所有任务状态"]
CheckTasks --> ClassifyTasks["分类任务: New/Runnable vs Running/Terminated"]
ClassifyTasks --> CountRunning["统计正在运行的任务数量"]
CountRunning --> CheckResource["检查可用资源与最大任务数"]
CheckResource --> Compare["运行任务数 < 最大任务数?"]
Compare --> |是| StartNewTask["启动新任务"]
Compare --> |否| Wait["等待下一次检查"]
StartNewTask --> UpdateStatus["更新任务状态为Running"]
UpdateStatus --> Wait
```

**监控频率**由系统自动调度机制决定，监控器在任务调度循环中持续运行。**状态检查逻辑**基于任务的当前状态（New、Runnable、Running、Terminated）进行判断，只有处于New或Runnable状态的任务才会被考虑执行。

**自动恢复机制**体现在任务状态的动态调整上：当任务引擎终止时，系统会自动将其状态更新为Terminated，从而允许监控器在资源允许的情况下重新调度相关任务。

**Section sources**
- [task_monitor.py](file://src/backEnd/utils/task_monitor.py#L20-L93)

## 日志记录策略

### LogRecorder类日志策略
`LogRecorder`类继承自`logging.StreamHandler`，实现了将日志记录写入IPC数据库的自定义处理程序。所有日志消息都会被持久化存储到数据库中，以便于异步I/O通信和后续分析。

日志记录包含以下关键信息：
- 任务ID (taskid)
- 时间戳 (采用"%X"格式)
- 日志级别 (levelname)
- 日志消息内容 (msg)

```mermaid
classDiagram
class LogRecorder {
+emit(record)
}
LogRecorder --|> logging.StreamHandler : 继承
LogRecorder --> Database : 写入日志数据
```

**日志级别管理**遵循Python标准库logging模块的级别体系，包括DEBUG、INFO、WARNING、ERROR和CRITICAL等标准级别。系统通过logger对象的不同方法调用来实现不同级别的日志记录。

**Section sources**
- [LogRecorder.py](file://src/backEnd/model/LogRecorder.py#L6-L16)

## 系统关键指标收集

系统通过多种方式收集关键性能指标，为监控和分析提供数据支持。

### 指标收集方式
1. **任务执行时间**：通过记录任务的开始时间和结束时间来计算执行时长
2. **资源消耗**：利用psutil库获取CPU使用率、内存占用等系统资源信息
3. **错误率**：统计数据库errors表中的错误记录数量与总任务数的比例

```mermaid
graph TD
A[指标收集] --> B[任务执行时间]
A --> C[资源消耗]
A --> D[错误率]
B --> B1[开始时间]
B --> B2[结束时间]
B --> B3[执行时长计算]
C --> C1[CPU使用率]
C --> C2[内存占用]
C --> C3[进程信息]
D --> D1[错误日志计数]
D --> D2[任务总数]
D --> D3[错误率计算]
```

动态任务数调整基于当前CPU使用率：
- CPU使用率 < 20%：最大任务数 = 逻辑核心数 × 2
- CPU使用率 < 50%：最大任务数 = 逻辑核心数
- CPU使用率 ≥ 50%：最大任务数 = 逻辑核心数 // 2（最小为1）

**Section sources**
- [task_monitor.py](file://src/backEnd/utils/task_monitor.py#L6-L25)
- [Database.py](file://src/backEnd/model/Database.py#L77)

## 日志轮转与存储

### 存储位置
所有日志数据存储在SQLite数据库的`logs`表中，通过IPC机制与主进程通信。数据库连接由`conf.databaseCursor`管理，确保线程安全的访问。

### 轮转策略
系统采用基于数据库表的轮转策略，而非传统的文件轮转。当需要清理旧日志时，可通过SQL语句删除指定时间范围前的日志记录。

### 归档方案
建议的归档方案包括：
1. 定期将数据库中的日志导出为CSV或JSON格式文件
2. 按日期或任务ID对日志进行分区存储
3. 使用外部存储系统（如S3、NAS）保存历史归档日志
4. 建立日志保留策略，自动清理超过保留期限的日志数据

**Section sources**
- [LogRecorder.py](file://src/backEnd/model/LogRecorder.py#L10-L16)
- [Database.py](file://src/backEnd/model/Database.py)

## Prometheus与Grafana集成

### Prometheus指标暴露配置
虽然当前系统未直接集成Prometheus，但可通过以下方式实现指标暴露：

1. **创建指标导出端点**：在Web API中添加专门的/metrics端点
2. **转换数据库指标**：将数据库中的日志和任务数据转换为Prometheus指标格式
3. **暴露关键指标**：
   - sqlmap_tasks_running{taskid} 数量
   - sqlmap_tasks_total 指标
   - sqlmap_cpu_usage_percent 指标
   - sqlmap_memory_usage_bytes 指标
   - sqlmap_errors_total 指标

### Grafana监控面板建议
建议创建以下Grafana监控面板：

1. **任务概览面板**
   - 正在运行的任务数
   - 今日完成任务数
   - 任务成功率/失败率

2. **系统资源面板**
   - CPU使用率趋势图
   - 内存使用情况
   - 进程数量

3. **错误分析面板**
   - 按类型分类的错误统计
   - 错误发生时间分布
   - 高频错误详情

4. **性能分析面板**
   - 任务执行时间分布
   - 平均执行时长趋势
   - 资源消耗与任务数关系

**Section sources**
- [task_monitor.py](file://src/backEnd/utils/task_monitor.py)
- [LogRecorder.py](file://src/backEnd/model/LogRecorder.py)

## 异常告警机制

### 告警触发条件
系统可通过以下条件触发告警：
- 连续多个任务失败
- CPU使用率持续高于阈值（如80%）超过5分钟
- 内存使用率超过安全阈值
- 数据库连接失败
- 关键服务进程异常退出
- **新增** 后端健康检查连续失败超过3次

### 通知策略
建议的告警通知策略包括：
1. **分级通知机制**：
   - 一级告警（严重）：短信+电话+邮件通知
   - 二级告警（重要）：企业微信/钉钉+邮件通知
   - 三级告警（警告）：邮件通知

2. **通知内容应包含**：
   - 告警级别和类型
   - 发生时间
   - 相关任务ID（如有）
   - 错误详情摘要
   - 可能的原因分析
   - 建议的处理措施

3. **静默期设置**：对于已知维护时段或已知问题，可设置告警静默期避免重复通知

**Section sources**
- [task_monitor.py](file://src/backEnd/utils/task_monitor.py)
- [LogRecorder.py](file://src/backEnd/model/LogRecorder.py)
- [app.py](file://src/backEnd/app.py#L46-L64) - *健康检查告警源*

## 性能瓶颈分析指南

### 常见性能瓶颈
1. **CPU瓶颈**：当CPU使用率持续接近100%时，可能导致任务调度延迟
2. **I/O瓶颈**：频繁的数据库读写操作可能成为性能限制因素
3. **内存瓶颈**：大量并发任务可能导致内存不足
4. **网络瓶颈**：目标系统响应慢会影响整体扫描效率

### 分析方法
1. **监控任务队列长度**：观察可运行任务积压情况
2. **分析任务执行时间分布**：识别异常长的任务
3. **检查系统资源使用趋势**：关联资源使用与任务执行情况
4. **审查错误日志模式**：识别重复出现的错误类型

### 优化建议
1. **调整最大任务数**：根据实际硬件配置和工作负载动态调整
2. **优化数据库访问**：考虑对频繁查询的表添加索引
3. **实施任务优先级**：为重要任务分配更高优先级
4. **定期清理历史数据**：避免数据库过大影响性能

**Section sources**
- [task_monitor.py](file://src/backEnd/utils/task_monitor.py)
- [config.py](file://src/backEnd/config.py)

## 系统健康检查清单

### 日常检查项
- [ ] 数据库连接是否正常
- [ ] 任务监控器是否正常运行
- [ ] 系统资源使用是否在正常范围内
- [ ] 日志记录是否正常
- [ ] 无异常堆积的任务
- [ ] **新增** `/api/health` 端点是否返回健康状态

### 周期性检查项
- [ ] 数据库文件大小是否超出预期
- [ ] 磁盘空间是否充足
- [ ] 备份是否成功完成
- [ ] 安全补丁是否及时更新
- [ ] 系统性能是否有下降趋势

### 故障排查步骤
1. 检查`logs`表中最近的错误记录
2. 验证数据库连接状态
3. 检查任务监控器的运行状态
4. 查看系统资源使用情况
5. 确认配置参数是否正确
6. **新增** 检查 `/api/health` 端点的响应
7. 重启相关服务（如必要）

**Section sources**
- [task_monitor.py](file://src/backEnd/utils/task_monitor.py)
- [LogRecorder.py](file://src/backEnd/model/LogRecorder.py)
- [Database.py](file://src/backEnd/model/Database.py)
- [app.py](file://src/backEnd/app.py#L46-L64) - *健康检查端点*