# Header配置功能 - 快速使用指南

## 🎯 功能概述

配置页面现在包含3个Tab标签页：

1. **系统配置** - 自动刷新间隔设置
2. **Header规则管理** - 持久化请求头规则配置
3. **会话Header管理** - 临时会话级请求头配置

---

## 📖 使用教程

### 一、Header规则管理

#### 1. 创建全局规则（最常用）

**场景**: 为所有扫描任务添加统一的User-Agent

**步骤**:
1. 点击进入「Header规则管理」Tab
2. 点击「添加规则」按钮
3. 填写表单:
   - 规则名称: `全局User-Agent`
   - Header名称: `User-Agent`
   - Header值: `Mozilla/5.0 SecurityScanner/1.0`
   - 替换策略: `完全替换`
   - 优先级: `50`
   - ✅ 启用规则
   - ❌ 不勾选「配置作用域」（全局生效）
4. 点击「保存」

✅ **结果**: 所有扫描任务都会使用这个User-Agent

---

#### 2. 创建带作用域的规则

**场景**: 只为生产环境API添加认证Token

**步骤**:
1. 点击「添加规则」
2. 填写表单:
   - 规则名称: `生产环境API认证`
   - Header名称: `Authorization`
   - Header值: `Bearer eyJhbGc...`
   - 优先级: `80` (高优先级)
   - ✅ 启用规则
   - ✅ 勾选「配置作用域」
3. 配置作用域:
   - 协议匹配: `https`
   - 主机名匹配: `api.production.com`
   - 路径匹配: `/v1/*`
   - ❌ 不使用正则表达式
4. 点击「保存」

✅ **结果**: 
- ✅ 只对 `https://api.production.com/v1/*` 的请求添加认证头
- ❌ 其他URL不受影响

---

#### 3. 编辑现有规则

**步骤**:
1. 在规则列表中找到要编辑的规则
2. 点击「编辑」按钮(铅笔图标)
3. 修改需要的字段
4. 点击「保存」

---

#### 4. 启用/禁用规则

**场景**: 临时禁用某个规则而不删除

**步骤**:
1. 找到要禁用的规则
2. 点击「眼睛/斜眼」图标
3. 确认状态变为「禁用」(红色Tag)

💡 **提示**: 禁用的规则不会应用到扫描任务，但保留在数据库中

---

#### 5. 删除规则

**步骤**:
1. 找到要删除的规则
2. 点击「删除」按钮(垃圾桶图标)
3. 在确认对话框中点击「删除」

⚠️ **警告**: 删除操作不可恢复

---

### 二、会话Header管理

#### 1. 批量添加临时Headers

**场景**: 为当前测试会话添加多个临时Headers

**步骤**:
1. 点击进入「会话Header管理」Tab
2. 点击「添加Header」按钮
3. 在文本框中输入多行Headers:
   ```
   Authorization: Bearer temp-token-123
   X-Request-ID: test-request-001
   X-Custom-Header: custom-value
   ```
4. 设置参数:
   - 优先级: `50`
   - 生存时间: `3600` 秒(1小时)
5. 点击「添加」

✅ **结果**: 这些Headers将在接下来的1小时内对所有请求生效

---

#### 2. 查看会话Headers

**步骤**:
1. 进入「会话Header管理」Tab
2. 查看列表显示:
   - Header名称和值
   - 优先级
   - 过期时间
   - 创建时间

---

#### 3. 清除所有会话Headers

**步骤**:
1. 点击「清除所有」按钮
2. 在确认对话框中点击「清除」

✅ **结果**: 所有会话Headers立即清除

---

## 🎨 作用域配置详解

### 作用域字段说明

| 字段 | 说明 | 示例 |
|------|------|------|
| 协议匹配 | 匹配http或https | `https` 或 `http,https` |
| 主机名匹配 | 匹配域名(支持通配符*) | `api.example.com` 或 `*.example.com` |
| IP匹配 | 匹配IP地址(支持通配符*) | `192.168.1.100` 或 `192.168.*` |
| 端口匹配 | 匹配端口号(支持多个) | `443` 或 `80,443,8080` |
| 路径匹配 | 匹配URL路径(支持通配符*) | `/api/*` 或 `/v1/users` |
| 使用正则 | 是否使用正则表达式 | ☐ 关键字匹配 ☑ 正则匹配 |

### 匹配逻辑

- **不填写作用域**: 全局生效，匹配所有URL
- **填写作用域**: 所有配置项都必须匹配才生效(AND逻辑)
- **字段留空**: 该维度不限制(等同于通配符)

### 作用域示例

#### 示例1: 只匹配HTTPS
```json
{
  "protocol_pattern": "https"
}
```
✅ 匹配: `https://任何域名/任何路径`  
❌ 不匹配: `http://...`

#### 示例2: 匹配example.com的所有子域名
```json
{
  "host_pattern": "*.example.com"
}
```
✅ 匹配:
- `http://api.example.com`
- `https://www.example.com`
- `http://test.example.com`

❌ 不匹配:
- `http://example.com` (主域名不匹配)
- `http://example.org`

#### 示例3: 匹配特定API路径
```json
{
  "protocol_pattern": "https",
  "host_pattern": "api.production.com",
  "path_pattern": "/v1/*"
}
```
✅ 匹配:
- `https://api.production.com/v1/users`
- `https://api.production.com/v1/products`

❌ 不匹配:
- `https://api.production.com/v2/users` (路径不匹配)
- `http://api.production.com/v1/users` (协议不匹配)

---

## 💡 最佳实践

### 1. 规则命名规范

推荐使用描述性名称:
- ✅ `生产环境API认证`
- ✅ `测试环境User-Agent`
- ✅ `全局请求ID`
- ❌ `规则1`
- ❌ `test`

### 2. 优先级设置建议

| 优先级范围 | 建议用途 | Tag颜色 |
|-----------|---------|---------|
| 80-100 | 关键认证/授权Header | 🔴 红色 |
| 50-79 | 重要业务Header | 🟡 黄色 |
| 0-49 | 一般Header | 🔵 蓝色 |

### 3. 作用域使用建议

**何时使用全局规则**:
- User-Agent统一设置
- 通用请求头(如Content-Type)
- 所有请求都需要的Header

**何时使用作用域规则**:
- 特定环境的认证Token
- 特定API的特殊Header
- 内网/外网区分
- 不同版本API的差异化Header

### 4. 会话Header使用建议

**适合场景**:
- 临时测试
- 一次性认证
- 短期实验

**不适合场景**:
- 长期稳定的配置(使用持久化规则)
- 需要跨会话保持的配置

---

## 🔧 故障排查

### 问题1: 规则创建失败

**可能原因**:
- 必填字段未填写
- 规则名称重复
- 后端服务未启动

**解决方法**:
1. 检查必填字段(名称、Header名称、Header值)
2. 使用唯一的规则名称
3. 确认后端服务运行在 `http://localhost:8000`

---

### 问题2: 规则不生效

**可能原因**:
- 规则被禁用
- 作用域配置不匹配
- 优先级被其他规则覆盖

**解决方法**:
1. 检查规则状态是否为「启用」
2. 检查作用域配置是否匹配目标URL
3. 检查是否有更高优先级的规则

---

### 问题3: Session Headers看不到

**可能原因**:
- 已过期(超过TTL)
- 浏览器会话已清除
- 后端服务重启

**解决方法**:
1. 重新添加Session Headers
2. 设置更长的TTL
3. 考虑使用持久化规则

---

## 📊 功能对比

| 特性 | 持久化规则 | 会话Header |
|------|-----------|-----------|
| 存储方式 | 数据库 | 内存 |
| 有效期 | 永久(除非删除) | 临时(TTL或会话结束) |
| 作用域 | ✅ 支持 | ❌ 不支持 |
| 优先级 | ✅ 支持 | ✅ 支持 |
| 批量操作 | ❌ 单个操作 | ✅ 批量添加 |
| 适用场景 | 长期配置 | 临时测试 |

---

## 🎯 常见使用场景

### 场景1: 为所有扫描添加自定义User-Agent

**步骤**:
1. 创建持久化规则
2. 不配置作用域(全局)
3. 设置合适的优先级

### 场景2: 为生产环境添加认证Token

**步骤**:
1. 创建持久化规则
2. 配置作用域(协议+域名)
3. 设置高优先级(80+)

### 场景3: 临时测试某个API

**步骤**:
1. 使用会话Header
2. 批量添加测试Headers
3. 测试完成后清除

---

## 📞 技术支持

如有问题，请查阅:
- 后端API文档: `src/backEnd/SCOPE_CRUD_COMPLETION_REPORT.md`
- 前端实现文档: `HEADER_CONFIG_UI_IMPLEMENTATION.md`
- Scope功能总结: `SCOPE_FEATURE_COMPLETION.md`

---

**更新时间**: 2025-10-26  
**版本**: v1.0
