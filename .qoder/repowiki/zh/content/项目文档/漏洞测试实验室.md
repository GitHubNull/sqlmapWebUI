# 漏洞测试实验室

<cite>
**本文档引用的文件**   
- [README.md](file://README.md)
- [app.py](file://src/backEnd/app.py)
- [main.py](file://src/backEnd/main.py)
- [config.py](file://src/backEnd/config.py)
- [DataStore.py](file://src/backEnd/model/DataStore.py)
- [Task.py](file://src/backEnd/model/Task.py)
- [taskService.py](file://src/backEnd/service/taskService.py)
- [task_monitor.py](file://src/backEnd/utils/task_monitor.py)
- [headerController.py](file://src/backEnd/api/commonApi/headerController.py)
- [headerRuleService.py](file://src/backEnd/service/headerRuleService.py)
- [header_processor.py](file://src/backEnd/utils/header_processor.py)
- [session_header_manager.py](file://src/backEnd/utils/session_header_manager.py)
- [server.py](file://src/vulnTestServer/server.py)
</cite>

## 目录
1. [简介](#简介)
2. [项目结构](#项目结构)
3. [核心组件](#核心组件)
4. [架构概述](#架构概述)
5. [详细组件分析](#详细组件分析)
6. [依赖分析](#依赖分析)
7. [性能考虑](#性能考虑)
8. [故障排除指南](#故障排除指南)
9. [结论](#结论)

## 简介
漏洞测试实验室是一个现代化的SQLMap Web界面，为安全研究人员提供便捷的SQL注入测试平台。该项目集成了SQLMap自动化检测工具，提供了任务管理、实时日志监控、扫描结果展示等功能。系统内置VulnShop漏洞靶场，包含8种SQL注入漏洞类型，支持亮色/暗色主题切换，提供完整的购物流程模拟。项目采用前后端分离架构，后端使用FastAPI框架，前端使用Vue 3框架，通过Burp Suite插件和Chrome扩展实现与安全测试工具的集成。

## 项目结构

```mermaid
graph TD
sqlmapWebUI["sqlmapWebUI/"]
src["src/"]
backEnd["backEnd/"]
frontEnd["frontEnd/"]
burpEx["burpEx/"]
vulnTestServer["vulnTestServer/"]
doc["doc/"]
src --> backEnd
src --> frontEnd
src --> burpEx
src --> vulnTestServer
backEnd --> api
backEnd --> model
backEnd --> service
backEnd --> utils
backEnd --> third_lib
backEnd --> app.py
backEnd --> main.py
api --> chromeExApi
api --> burpSuiteExApi
api --> commonApi
model --> Task.py
model --> DataStore.py
model --> Database.py
model --> TaskStatus.py
service --> taskService.py
service --> headerRuleService.py
utils --> task_monitor.py
utils --> header_processor.py
utils --> session_header_manager.py
third_lib --> sqlmap
frontEnd --> src
frontEnd --> package.json
frontEnd --> pnpm-lock.yaml
src --> api
src --> components
src --> stores
src --> views
src --> utils
burpEx --> legacy-api
burpEx --> montoya-api
vulnTestServer --> server.py
vulnTestServer --> database.py
vulnTestServer --> waf.py
doc --> README.md
doc --> USAGE_GUIDE.md
doc --> FEATURE_UPDATES.md
sqlmapWebUI --> src
sqlmapWebUI --> doc
sqlmapWebUI --> .gitignore
sqlmapWebUI --> README.md
```

**图源**
- [README.md](file://README.md#L127-L161)

**本节源**
- [README.md](file://README.md#L127-L161)

## 核心组件

漏洞测试实验室的核心组件包括任务管理、请求头规则处理、扫描引擎集成和漏洞靶场。任务管理组件负责创建、监控和管理SQL注入扫描任务，通过TaskService类实现任务的生命周期管理。请求头规则处理组件支持持久化规则和会话性请求头，允许用户灵活配置自定义请求头规则。扫描引擎集成组件将SQLMap工具封装为API服务，实现自动化扫描。漏洞靶场组件提供了一个包含多种SQL注入漏洞的模拟电商平台，用于安全测试和教育目的。

**本节源**
- [README.md](file://README.md#L17-L52)
- [app.py](file://src/backEnd/app.py#L1-L74)
- [main.py](file://src/backEnd/main.py#L1-L163)

## 架构概述

```mermaid
graph TD
Client["客户端 (浏览器)"]
Frontend["前端 (Vue 3)"]
Backend["后端 (FastAPI)"]
SQLMap["SQLMap 扫描引擎"]
Database["数据库 (SQLite)"]
Client --> Frontend
Frontend --> Backend
Backend --> SQLMap
Backend --> Database
SQLMap --> Database
subgraph "前端"
Frontend
Router["Vue Router"]
Pinia["Pinia 状态管理"]
PrimeVue["PrimeVue UI 组件"]
end
subgraph "后端"
Backend
ApiService["API 服务"]
TaskManager["任务管理"]
HeaderRuleService["请求头规则服务"]
end
subgraph "集成"
SQLMap
BurpSuite["Burp Suite 插件"]
ChromeExt["Chrome 扩展"]
end
BurpSuite --> Backend
ChromeExt --> Backend
```

**图源**
- [app.py](file://src/backEnd/app.py#L1-L74)
- [main.py](file://src/backEnd/main.py#L1-L163)
- [server.py](file://src/vulnTestServer/server.py#L1-L685)

**本节源**
- [app.py](file://src/backEnd/app.py#L1-L74)
- [main.py](file://src/backEnd/main.py#L1-L163)

## 详细组件分析

### 任务管理组件分析

任务管理组件是漏洞测试实验室的核心功能之一，负责处理SQL注入扫描任务的整个生命周期。该组件通过TaskService类实现，提供了创建、启动、停止、删除和查询任务的功能。每个任务在创建时会分配一个唯一的任务ID，并存储在DataStore的有序字典中。任务状态包括新建(New)、可运行(Runnable)、运行中(Running)、阻塞(Blocked)和终止(Terminated)。

```mermaid
classDiagram
class Task {
+status : TaskStatus
+create_datetime : datetime
+start_datetime : datetime
+taskid : str
+scanUrl : str
+host : str
+headers : list
+body : str
+process : Popen
+output_directory : str
+options : AttribDict
+_original_options : AttribDict
+_header_rules_applied : bool
+__init__(taskid, remote_addr, scanUrl, host, headers, body)
+initialize_options(taskid)
+set_option(option, value)
+get_option(option)
+get_options()
+reset_options()
+apply_header_rules()
+engine_start()
+engine_stop()
+engine_process()
+engine_kill()
+engine_get_id()
+engine_get_returncode()
+engine_has_terminated()
}
class TaskService {
+star_task(remote_addr, scanUrl, host, headers, body, options)
+delete_task(taskid)
+list_task()
+kill_task(taskid)
+stop_task(taskid)
+start_task_with_taskid(taskid)
+flush_task()
+find_task_by_urlPath(urlPath)
+find_task_by_taskid(taskid)
+find_task_by_bodyKeyWord(requestBodyKeyWord)
+find_task_by_KeyWord(keyword)
+find_task_by_header_keyword(headerKeyWord)
+find_task_by_requestHost(requestHost)
+find_task_log_by_taskid(taskid)
+get_payload_detail_by_task_id(taskId)
+get_task_http_request_info(taskId)
+get_task_scan_options(taskId)
+get_task_errors_by_taskId(taskId)
}
class DataStore {
+admin_token : str
+current_db : Database
+header_db : HeaderDatabase
+tasks_lock : Lock
+tasks : OrderedDict
+username : str
+password : str
+first_checkin_monitor : bool
+max_tasks_count : int
+max_tasks_count_lock : Lock
+session_header_manager : SessionHeaderManager
+session_header_manager_lock : Lock
+get_session_header_manager()
}
TaskService --> Task : "创建"
TaskService --> DataStore : "访问"
DataStore --> Task : "存储"
```

**图源**
- [Task.py](file://src/backEnd/model/Task.py#L20-L209)
- [taskService.py](file://src/backEnd/service/taskService.py#L46-L534)
- [DataStore.py](file://src/backEnd/model/DataStore.py#L9-L34)

**本节源**
- [Task.py](file://src/backEnd/model/Task.py#L1-L209)
- [taskService.py](file://src/backEnd/service/taskService.py#L1-L535)
- [DataStore.py](file://src/backEnd/model/DataStore.py#L1-L34)

### 请求头规则组件分析

请求头规则组件提供了灵活的请求头管理功能，支持持久化规则和会话性请求头。持久化规则存储在数据库中，具有名称、优先级、作用域等属性，可以配置不同的替换策略。会话性请求头基于客户端IP地址管理，具有生存时间(TTL)和优先级，适用于临时的请求头设置。该组件通过HeaderRuleService类实现业务逻辑，HeaderProcessor类处理请求头的解析和应用。

```mermaid
classDiagram
class HeaderRuleService {
+_get_db()
+_check_db_connection()
+_get_current_time()
+_validate_rule_data(rule_data)
+create_persistent_rule(rule_data)
+get_persistent_rules(active_only)
+get_persistent_rule_by_id(rule_id)
+update_persistent_rule(rule_id, update_data)
+delete_persistent_rule(rule_id)
+get_active_persistent_rules_for_processing()
+preview_header_processing(headers, client_ip, target_url)
+parse_headers_batch(request)
+create_persistent_rules_batch(request)
+create_session_headers_batch(request, client_ip)
+create_headers_batch(request, client_ip)
}
class HeaderProcessor {
+normalize_headers(headers)
+format_headers_for_sqlmap(headers)
+validate_header_name(header_name)
+apply_replace_strategy(existing_value, new_value, strategy)
+match_condition(header_value, condition)
+apply_persistent_rules(headers_dict, rules, target_url)
+apply_session_headers(headers_dict, session_headers, target_url)
+process_headers(original_headers, persistent_rules, session_headers, target_url)
+preview_header_processing(original_headers, persistent_rules, session_headers, target_url)
}
class SessionHeaderManager {
+_session_headers : Dict[str, Dict[str, SessionHeader]]
+_lock : Lock
+set_session_header(client_ip, header_create)
+set_session_headers_batch(client_ip, headers)
+get_session_headers(client_ip, active_only)
+get_all_session_headers(client_ip)
+remove_session_header(client_ip, header_name)
+clear_session_headers(client_ip)
+cleanup_expired_headers()
+get_client_count()
+get_total_headers_count()
+get_active_headers_count()
}
HeaderRuleService --> HeaderProcessor : "使用"
HeaderRuleService --> SessionHeaderManager : "使用"
HeaderProcessor --> SessionHeaderManager : "使用"
```

**图源**
- [headerRuleService.py](file://src/backEnd/service/headerRuleService.py#L32-L800)
- [header_processor.py](file://src/backEnd/utils/header_processor.py#L12-L292)
- [session_header_manager.py](file://src/backEnd/utils/session_header_manager.py#L14-L260)

**本节源**
- [headerRuleService.py](file://src/backEnd/service/headerRuleService.py#L1-L800)
- [header_processor.py](file://src/backEnd/utils/header_processor.py#L1-L292)
- [session_header_manager.py](file://src/backEnd/utils/session_header_manager.py#L1-L260)

### 漏洞靶场组件分析

漏洞靶场组件提供了一个包含多种SQL注入漏洞的模拟电商平台，用于安全测试和教育目的。该组件通过Python内置的HTTPServer实现，提供了8种不同类型的SQL注入漏洞，包括基于错误的注入、联合查询注入、布尔盲注、时间盲注、堆叠查询注入和二次注入。靶场支持3种难度级别，配合WAF防护，提供了完整的购物流程模拟。

```mermaid
sequenceDiagram
participant Client as "客户端"
participant Server as "VulnShop服务器"
participant WAF as "WAF模块"
participant Database as "SQLite数据库"
Client->>Server : POST /api/user/login
Server->>WAF : filter_input(username)
WAF-->>Server : 过滤后的用户名
Server->>Database : SELECT * FROM users WHERE username = '{username}' AND password = '{hash_password(password)}'
Database-->>Server : 查询结果
alt 登录成功
Server-->>Client : {success : true, data : user_info}
else 登录失败
Server-->>Client : {success : false, message : "Invalid username or password"}
end
Client->>Server : GET /api/products/search?keyword=test
Server->>WAF : filter_input(keyword)
WAF-->>Server : 过滤后的关键词
Server->>Database : SELECT id, name, price, category FROM products WHERE name LIKE '%{keyword}%'
Database-->>Server : 商品列表
Server-->>Client : {success : true, data : products}
Client->>Server : GET /api/products/detail?id=1
Server->>Database : SELECT * FROM products WHERE id = {product_id}
Database-->>Server : 商品详情
Server-->>Client : {success : true, data : product}
Client->>Server : GET /api/user/profile?id=1
Server->>Database : SELECT id, username, email, phone, address, balance FROM users WHERE id = {user_id}
Database-->>Server : 用户资料
Server-->>Client : {success : true, data : profile}
```

**图源**
- [server.py](file://src/vulnTestServer/server.py#L37-L685)

**本节源**
- [server.py](file://src/vulnTestServer/server.py#L1-L685)

## 依赖分析

```mermaid
graph TD
app["app.py"]
main["main.py"]
taskService["taskService.py"]
task["Task.py"]
DataStore["DataStore.py"]
headerController["headerController.py"]
headerRuleService["headerRuleService.py"]
header_processor["header_processor.py"]
session_header_manager["session_header_manager.py"]
main --> app
main --> task_monitor
main --> DataStore
main --> task
main --> sqlmap
app --> main
app --> headerController
app --> taskService
taskService --> DataStore
taskService --> task
taskService --> BaseResponseMsg
task --> DataStore
task --> TaskStatus
task --> Database
task --> header_processor
task --> headerRuleService
headerController --> headerRuleService
headerController --> DataStore
headerController --> BaseResponseMsg
headerRuleService --> header_processor
headerRuleService --> session_header_manager
headerRuleService --> DataStore
headerRuleService --> BaseResponseMsg
header_processor --> session_header_manager
header_processor --> PersistentHeaderRule
header_processor --> SessionHeader
header_processor --> ScopeMatcher
session_header_manager --> DataStore
session_header_manager --> SessionHeader
```

**图源**
- [app.py](file://src/backEnd/app.py#L1-L74)
- [main.py](file://src/backEnd/main.py#L1-L163)
- [taskService.py](file://src/backEnd/service/taskService.py#L1-L535)
- [Task.py](file://src/backEnd/model/Task.py#L1-L209)
- [DataStore.py](file://src/backEnd/model/DataStore.py#L1-L34)
- [headerController.py](file://src/backEnd/api/commonApi/headerController.py#L1-L463)
- [headerRuleService.py](file://src/backEnd/service/headerRuleService.py#L1-L800)
- [header_processor.py](file://src/backEnd/utils/header_processor.py#L1-L292)
- [session_header_manager.py](file://src/backEnd/utils/session_header_manager.py#L1-L260)

**本节源**
- [app.py](file://src/backEnd/app.py#L1-L74)
- [main.py](file://src/backEnd/main.py#L1-L163)
- [taskService.py](file://src/backEnd/service/taskService.py#L1-L535)

## 性能考虑

漏洞测试实验室在性能方面进行了多项优化。任务监控器(task_monitor)使用BackgroundScheduler定期检查任务状态，动态调整最大并发任务数，根据CPU使用率和逻辑核心数决定可同时运行的任务数量。系统通过DataStore的线程锁(tasks_lock)确保多线程环境下的数据一致性，避免竞态条件。请求头处理组件采用高效的字符串操作和正则表达式匹配，确保请求头处理的性能。SQLMap扫描任务在独立进程中运行，避免阻塞主线程，提高系统的响应性。

**本节源**
- [task_monitor.py](file://src/backEnd/utils/task_monitor.py#L1-L94)
- [config.py](file://src/backEnd/config.py#L1-L8)
- [main.py](file://src/backEnd/main.py#L107-L156)

## 故障排除指南

当遇到问题时，可以按照以下步骤进行排查：

1. **检查服务状态**：访问`/api/health`端点检查后端服务是否正常运行。
2. **查看日志**：检查后端日志文件，查找错误信息和异常堆栈。
3. **验证数据库连接**：确保DataStore.current_db和DataStore.header_db连接正常。
4. **检查任务状态**：使用`list_task`接口查看任务列表和状态。
5. **验证请求头规则**：使用`preview_header_processing`接口预览请求头处理结果。
6. **检查WAF配置**：如果请求被阻止，检查WAF的过滤规则和难度级别。

常见问题包括数据库连接失败、任务启动失败、请求头规则不生效等。对于数据库连接问题，确保DataStore在main.py中正确初始化。对于任务启动失败，检查SQLMap的安装路径和配置文件。对于请求头规则问题，验证规则的优先级、作用域和替换策略设置是否正确。

**本节源**
- [main.py](file://src/backEnd/main.py#L137-L149)
- [taskService.py](file://src/backEnd/service/taskService.py#L58-L87)
- [headerRuleService.py](file://src/backEnd/service/headerRuleService.py#L77-L85)
- [task_monitor.py](file://src/backEnd/utils/task_monitor.py#L37-L40)

## 结论

漏洞测试实验室是一个功能完善的SQL注入测试平台，集成了任务管理、请求头规则处理、扫描引擎集成和漏洞靶场等核心功能。系统采用现代化的技术栈，前后端分离架构，提供了友好的用户界面和丰富的API接口。通过深入分析代码结构和组件关系，我们可以更好地理解系统的运行机制和设计原理。该平台不仅适用于安全研究人员进行SQL注入测试，也可作为教育工具帮助学习者理解SQL注入漏洞的原理和防御方法。