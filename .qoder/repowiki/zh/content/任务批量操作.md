# 任务批量操作

<cite>
**本文档中引用的文件**  
- [taskService.py](file://src/backEnd/service/taskService.py)
- [Task.py](file://src/backEnd/model/Task.py)
- [TaskRequest.py](file://src/backEnd/model/requestModel/TaskRequest.py)
- [task.ts](file://src/frontEnd/src/stores/task.ts)
- [task.ts](file://src/frontEnd/src/api/task.ts)
</cite>

## 目录
1. [简介](#简介)
2. [API接口设计](#api接口设计)
3. [前端Store实现逻辑](#前端store实现逻辑)
4. [用户界面交互流程](#用户界面交互流程)
5. [确认对话框设计](#确认对话框设计)
6. [错误处理机制](#错误处理机制)
7. [使用示例与最佳实践](#使用示例与最佳实践)

## 简介
本系统提供任务批量操作功能，支持批量停止和批量删除任务。该功能通过前后端协同工作，实现对多个任务的高效管理。系统采用模块化设计，后端提供RESTful API接口，前端通过Pinia状态管理实现数据同步与操作控制。

## API接口设计

### 批量停止任务API
- **端点**: `PUT /chrome/admin/task/stop`
- **参数**: `taskId`（任务ID，通过查询参数传递）
- **功能**: 停止指定任务，支持单个任务操作
- **状态转换**:
  - 运行中 → 阻塞
  - 新建/可运行 → 阻塞
  - 已阻塞/已终止 → 返回错误

### 批量删除任务API
- **端点**: `DELETE /chrome/admin/task/delete`
- **参数**: `taskId`（任务ID，通过查询参数传递）
- **功能**: 删除指定任务，若任务正在运行则先终止再删除

### 批量操作实现
后端未提供原生批量操作接口，前端通过循环调用单个任务操作接口实现批量功能。

**Section sources**
- [taskService.py](file://src/backEnd/service/taskService.py#L200-L250)
- [TaskRequest.py](file://src/backEnd/model/requestModel/TaskRequest.py#L40-L45)

## 前端Store实现逻辑

### 批量删除实现
```typescript
async function batchDeleteTasks(taskIds: string[]): Promise<void> {
  loading.value = true
  try {
    await batchDeleteTasksApi(taskIds)
    taskList.value = taskList.value.filter((t) => !taskIds.includes(t.taskid))
    clearSelection()
  } catch (error) {
    console.debug('batchDeleteTasks error:', error)
    throw error
  } finally {
    loading.value = false
  }
}
```

### 批量停止实现
```typescript
async function batchStopTasks(taskIds: string[]): Promise<void> {
  loading.value = true
  try {
    await batchStopTasksApi(taskIds)
    await fetchTaskList()
  } catch (error) {
    console.debug('batchStopTasks error:', error)
    throw error
  } finally {
    loading.value = false
  }
}
```

### 状态管理特性
- 使用Pinia进行状态管理
- 维护任务列表、选中任务ID、加载状态等
- 提供计算属性实现过滤、排序和统计功能
- 支持任务选择、全选、反选等操作

**Section sources**
- [task.ts](file://src/frontEnd/src/stores/task.ts#L300-L366)
- [task.ts](file://src/frontEnd/src/api/task.ts#L120-L146)

## 用户界面交互流程

### 批量操作流程
1. 用户在任务列表中选择一个或多个任务
2. 点击"批量停止"或"批量删除"按钮
3. 系统弹出确认对话框
4. 用户确认后，执行相应操作
5. 操作完成后刷新任务列表

### 选择机制
- 单个任务选择：点击任务行或选择框
- 全选：点击全选复选框
- 反选：结合Ctrl键点击
- 范围选择：结合Shift键点击

### 状态反馈
- 操作过程中显示加载状态
- 操作成功后自动刷新列表
- 错误发生时显示错误信息
- 提供操作结果通知

## 确认对话框设计

### 设计原则
- **安全性**: 防止误操作
- **清晰性**: 明确操作后果
- **一致性**: 统一交互模式
- **效率**: 减少操作步骤

### 对话框内容
- **标题**: 根据操作类型显示"确认批量停止"或"确认批量删除"
- **消息**: 显示将要操作的任务数量和简要说明
- **操作按钮**:
  - 确认按钮（主按钮）
  - 取消按钮（次按钮）
- **视觉反馈**: 操作过程中显示加载状态

### 交互细节
- 点击确认按钮后禁用按钮防止重复提交
- 支持ESC键关闭对话框
- 点击遮罩层不关闭对话框（防止误触）
- 操作成功后自动关闭对话框

## 错误处理机制

### 前端错误处理
- 统一在API请求层处理错误
- 操作失败时保持对话框打开状态
- 显示具体的错误信息
- 提供重试或取消选项

### 后端错误处理
- 任务不存在时返回404状态码
- 状态非法时返回400状态码
- 数据库错误时返回500状态码
- 详细日志记录便于排查

### 异常情况处理
- **部分成功**: 批量操作中部分任务失败
  - 继续执行剩余任务
  - 收集所有错误信息
  - 最终显示汇总报告
- **网络中断**: 
  - 显示网络错误提示
  - 提供重试机制
  - 保持当前状态

**Section sources**
- [task.ts](file://src/frontEnd/src/stores/task.ts#L300-L366)
- [taskService.py](file://src/backEnd/service/taskService.py#L200-L250)

## 使用示例与最佳实践

### 使用示例
```typescript
// 批量停止选中任务
const selectedIds = useTaskStore().selectedTaskIds
if (selectedIds.length > 0) {
  await useTaskStore().batchStopTasks(selectedIds)
}

// 批量删除已完成任务
const completedTasks = taskList.value.filter(t => 
  t.status === TaskStatus.SUCCESS || t.status === TaskStatus.FAILED
)
if (completedTasks.length > 0) {
  const ids = completedTasks.map(t => t.taskid)
  await useTaskStore().batchDeleteTasks(ids)
}
```

### 最佳实践
1. **操作确认**: 对删除操作必须进行二次确认
2. **批量大小**: 建议单次批量操作不超过100个任务
3. **错误处理**: 实现部分失败的优雅处理
4. **性能优化**: 对大量任务操作提供进度反馈
5. **用户体验**: 操作过程中保持界面响应性
6. **数据一致性**: 操作完成后及时刷新数据

### 注意事项
- 批量操作不可逆，请谨慎使用
- 建议先在测试环境验证操作
- 大批量操作可能需要较长时间
- 网络不稳定时建议分批操作

**Section sources**
- [task.ts](file://src/frontEnd/src/stores/task.ts#L300-L366)
- [taskService.py](file://src/backEnd/service/taskService.py#L200-L250)